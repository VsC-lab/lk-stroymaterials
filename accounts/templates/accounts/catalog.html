{% extends 'accounts/base.html' %}

{% block content %}
<div class="container mt-4">
    <h1 class="mb-4">üõí –ö–∞—Ç–∞–ª–æ–≥ —Ç–æ–≤–∞—Ä–æ–≤</h1>
    
    {% for category, category_products in categories.items %}
    <div class="card mb-4">
        <div class="card-header bg-light">
            <h3 class="mb-0">{{ category.name }}</h3>
        </div>
        <div class="card-body">
            <div class="row">
                {% for product in category_products %}
                <div class="col-md-3 mb-4">
                    <div class="card h-100 shadow-sm">
                        <div class="card-body">
                            <h5 class="card-title">{{ product.name }}</h5>
                            <p class="text-muted small mb-2">–ê—Ä—Ç–∏–∫—É–ª: {{ product.sku }}</p>
                            <p class="card-text small">{{ product.description|truncatechars:80 }}</p>
                            <p class="mb-2"><strong class="h5">{{ product.price }} ‚ÇΩ</strong></p>
                            <p class="small mb-3">
                                {% if product.stock > 10 %}
                                <span class="text-success">‚úÖ –í –Ω–∞–ª–∏—á–∏–∏: {{ product.stock }} {{ product.unit }}</span>
                                {% elif product.stock > 0 %}
                                <span class="text-warning">‚ö†Ô∏è –ú–∞–ª–æ: {{ product.stock }} {{ product.unit }}</span>
                                {% else %}
                                <span class="text-danger">‚ùå –ù–µ—Ç –≤ –Ω–∞–ª–∏—á–∏–∏</span>
                                {% endif %}
                            </p>
                        </div>
                        
                        <div class="card-footer bg-white border-top-0">
                            <!-- –û–°–ù–û–í–ù–ê–Ø –†–ê–ë–û–ß–ê–Ø –§–û–†–ú–ê -->
                            {% if product.stock > 0 %}
                            <form method="post" action="{% url 'add_to_cart' product.id %}" 
                                  class="mb-2" id="form-{{ product.id }}">
                                {% csrf_token %}
                                <div class="input-group input-group-sm">
                                    <input type="number" name="quantity" value="1" min="1" 
                                           max="{{ product.stock }}" class="form-control" 
                                           style="width: 70px;">
                                    <button type="submit" class="btn btn-primary btn-sm">
                                        <i class="bi bi-cart-plus"></i>
                                    </button>
                                </div>
                            </form>
                            {% else %}
                            <button class="btn btn-secondary btn-sm w-100" disabled>
                                <i class="bi bi-cart-x"></i> –ù–µ—Ç –≤ –Ω–∞–ª–∏—á–∏–∏
                            </button>
                            {% endif %}
                            
                            <!-- –¢–ï–°–¢–û–í–ê–Ø –ö–ù–û–ü–ö–ê (–≤—Å–µ–≥–¥–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç) -->
                            <div class="d-grid gap-1 mt-2">
                                <a href="/test-simple-add/{{ product.id }}/" 
                                   class="btn btn-success btn-sm">
                                    <i class="bi bi-check-circle"></i> –¢–µ—Å—Ç –¥–æ–±–∞–≤–ª–µ–Ω–∏—è
                                </a>
                                
                                <button class="btn btn-outline-primary btn-sm test-ajax-btn"
                                        data-product-id="{{ product.id }}"
                                        data-product-name="{{ product.name }}">
                                    <i class="bi bi-lightning"></i> –ë—ã—Å—Ç—Ä–æ –¥–æ–±–∞–≤–∏—Ç—å
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% empty %}
    <div class="text-center py-5">
        <div class="display-1 mb-3">üì¶</div>
        <h3 class="mb-3">–ö–∞—Ç–∞–ª–æ–≥ –ø—É—Å—Ç</h3>
        <p class="text-muted">–¢–æ–≤–∞—Ä—ã –ø–æ–∫–∞ –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã –≤ —Å–∏—Å—Ç–µ–º—É</p>
    </div>
    {% endfor %}
</div>

<!-- –ü—Ä–æ—Å—Ç–æ–π JavaScript –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('–ö–∞—Ç–∞–ª–æ–≥ –∑–∞–≥—Ä—É–∂–µ–Ω');
    
    // 1. –õ–æ–≥–∏—Ä—É–µ–º –æ—Ç–ø—Ä–∞–≤–∫—É —Ñ–æ—Ä–º
    document.querySelectorAll('form[action*="/cart/add/"]').forEach(form => {
        form.addEventListener('submit', function(e) {
            console.log('üì§ –§–æ—Ä–º–∞ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è:', this.action);
            console.log('üì¶ –¢–æ–≤–∞—Ä ID:', this.action.split('/').filter(p => p).pop());
            console.log('üî¢ –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ:', this.querySelector('input[name="quantity"]').value);
        });
    });
    
    // 2. –¢–µ—Å—Ç–æ–≤–∞—è AJAX –∫–Ω–æ–ø–∫–∞
    document.querySelectorAll('.test-ajax-btn').forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.preventDefault();
            const productId = this.dataset.productId;
            const productName = this.dataset.productName;
            
            console.log(`üéØ AJAX –∑–∞–ø—Ä–æ—Å –¥–ª—è —Ç–æ–≤–∞—Ä–∞: ${productName} (ID: ${productId})`);
            
            // –ü—Ä–æ—Å—Ç–æ–π –∑–∞–ø—Ä–æ—Å
            fetch(`/cart/add/${productId}/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                },
                body: 'quantity=1'
            })
            .then(response => {
                console.log(`üì® –°—Ç–∞—Ç—É—Å –æ—Ç–≤–µ—Ç–∞: ${response.status}`);
                if (response.redirected) {
                    console.log(`üîÑ –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞: ${response.url}`);
                    window.location.href = response.url;
                }
                return response.text();
            })
            .then(text => {
                console.log('üìÑ –û—Ç–≤–µ—Ç –ø–æ–ª—É—á–µ–Ω');
                alert(`–¢–æ–≤–∞—Ä "${productName}" –¥–æ–±–∞–≤–ª–µ–Ω –≤ –∫–æ—Ä–∑–∏–Ω—É!`);
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ –∫–æ—Ä–∑–∏–Ω—ã
                fetch('/cart/get-count/')
                    .then(r => r.json())
                    .then(data => {
                        const counter = document.getElementById('cart-count');
                        if (counter) {
                            counter.textContent = data.count;
                        }
                    });
            })
            .catch(err => {
                console.error('‚ùå –û—à–∏–±–∫–∞:', err);
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –≤ –∫–æ—Ä–∑–∏–Ω—É');
            });
        });
    });
});

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—á–µ—Ç—á–∏–∫–∞ –∫–æ—Ä–∑–∏–Ω—ã
function updateCartCounter() {
    fetch('/cart/get-count/')
        .then(r => r.json())
        .then(data => {
            const counter = document.getElementById('cart-count');
            if (counter) {
                counter.textContent = data.count;
            }
        });
}
</script>

<style>
.card {
    transition: transform 0.2s;
}
.card:hover {
    transform: translateY(-5px);
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
}
.btn-primary {
    background-color: #0d6efd;
    border-color: #0d6efd;
}
.btn-success {
    background-color: #198754;
    border-color: #198754;
}
.input-group-sm .form-control {
    padding: 0.25rem 0.5rem;
    font-size: 0.875rem;
}
</style>
{% endblock %}