{% extends 'accounts/base.html' %}

{% block content %}
<div class="container mt-4">
    <h1 class="mb-4">üõí –ö–∞—Ç–∞–ª–æ–≥ —Ç–æ–≤–∞—Ä–æ–≤</h1>
    
    {% for category, category_products in categories.items %}
    <div class="card mb-4">
        <div class="card-header bg-light">
            <h3 class="mb-0">{{ category.name }}</h3>
        </div>
        <div class="card-body">
            <div class="row">
                {% for product in category_products %}
                <div class="col-md-3 mb-4">
                    <div class="card h-100 shadow-sm">
                        <div class="card-body">
                            <h5 class="card-title">{{ product.name }}</h5>
                            <p class="text-muted small mb-2">–ê—Ä—Ç–∏–∫—É–ª: {{ product.sku }}</p>
                            <p class="card-text small">{{ product.description|truncatechars:80 }}</p>
                            <p class="mb-2"><strong class="h5">{{ product.price }} ‚ÇΩ</strong></p>
                            <p class="small mb-3">
                                {% if product.stock > 10 %}
                                <span class="text-success">‚úÖ –í –Ω–∞–ª–∏—á–∏–∏: {{ product.stock }} {{ product.unit }}</span>
                                {% elif product.stock > 0 %}
                                <span class="text-warning">‚ö†Ô∏è –ú–∞–ª–æ: {{ product.stock }} {{ product.unit }}</span>
                                {% else %}
                                <span class="text-danger">‚ùå –ù–µ—Ç –≤ –Ω–∞–ª–∏—á–∏–∏</span>
                                {% endif %}
                            </p>
                        </div>
                        
                        <div class="card-footer bg-white border-top-0">
                            <!-- –û–°–ù–û–í–ù–ê–Ø –†–ê–ë–û–ß–ê–Ø –§–û–†–ú–ê -->
                            {% if product.stock > 0 %}
                            <form method="post" action="{% url 'add_to_cart' product.id %}" 
                                  class="mb-2" id="form-{{ product.id }}">
                                {% csrf_token %}
                                <div class="input-group input-group-sm">
                                    <input type="number" name="quantity" value="1" min="1" 
                                           max="{{ product.stock }}" class="form-control" 
                                           style="width: 70px;">
                                    <button type="submit" class="btn btn-primary btn-sm">
                                        <i class="bi bi-cart-plus"></i>
                                    </button>
                                </div>
                            </form>
                            {% else %}
                            <button class="btn btn-secondary btn-sm w-100" disabled>
                                <i class="bi bi-cart-x"></i> –ù–µ—Ç –≤ –Ω–∞–ª–∏—á–∏–∏
                            </button>
                            {% endif %}
                            
                            <!-- –¢–ï–°–¢–û–í–ê–Ø –ö–ù–û–ü–ö–ê (–≤—Å–µ–≥–¥–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç) -->
                            <div class="d-grid gap-1 mt-2">
                                <button onclick="testAddToCart({{ product.id }})" 
                                         class="btn btn-success btn-sm w-100 mt-2">
                                    <i class="bi bi-check-circle"></i> –¢–µ—Å—Ç –¥–æ–±–∞–≤–ª–µ–Ω–∏—è
                                </button>

                                <script>
                            // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–∞ –≤ –∫–æ—Ä–∑–∏–Ω—É
                                 function testAddToCart(productId) {
                                     console.log('–î–æ–±–∞–≤–ª—è–µ–º —Ç–æ–≤–∞—Ä ID:', productId);
                                     fetch(`/test-simple-add/${productId}/`, {
                                         method: 'POST',
                                         headers: {
                                            'Content-Type': 'application/json',
                                             'X-CSRFToken': getCSRFToken(), // –ü–æ–ª—É—á–∞–µ–º CSRF —Ç–æ–∫–µ–Ω
                                             'X-Requested-With': 'XMLHttpRequest'
                                        }
                                    })
                                    .then(response => {
                                         console.log('–û—Ç–≤–µ—Ç –ø–æ–ª—É—á–µ–Ω, —Å—Ç–∞—Ç—É—Å:', response.status);
                                         return response.json();
                                    })
                                    .then(data => {
                                        console.log('–î–∞–Ω–Ω—ã–µ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞:', data);

                                        if (data.success) {
                                            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É—Å–ø–µ—à–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
                                            showAlert('success', '‚úÖ ' + data.message + '<br>–¢–æ–≤–∞—Ä–æ–≤ –≤ –∫–æ—Ä–∑–∏–Ω–µ: ' + data.cart_count);

                                            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ –∫–æ—Ä–∑–∏–Ω—ã –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
                                            updateCartCounter(data.cart_count);
                                        } else {
                                            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫—É
                                            showAlert('error', '‚ùå –û—à–∏–±–∫–∞: ' + data.error);
                                        }
                                    })
                                    .catch(error => {
                                        console.error('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏:', error);
                                        showAlert('error', '–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º');
                                    });
                                }

                                // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è CSRF —Ç–æ–∫–µ–Ω–∞
                                function getCSRFToken() {
                                    // –ò—â–µ–º —Ç–æ–∫–µ–Ω –≤ —Ñ–æ—Ä–º–µ
                                    const tokenInput = document.querySelector('[name=csrfmiddlewaretoken]');
                                    if (tokenInput) {
                                        return tokenInput.value;
                                    }
                                    
                                    // –ò—â–µ–º –≤ cookies
                                    const cookies = document.cookie.split(';');
                                    for (let cookie of cookies) {
                                        const [name, value] = cookie.trim().split('=');
                                        if (name === 'csrftoken') {
                                            return value;
                                        }
                                    }
                                    
                                    console.warn('CSRF —Ç–æ–∫–µ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω!');
                                    return '';
                                }

                                // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
                                function showAlert(type, message) {
                                    // –°–æ–∑–¥–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
                                    const alertDiv = document.createElement('div');
                                    alertDiv.className = `alert alert-${type === 'success' ? 'success' : 'danger'} alert-dismissible fade show`;
                                    alertDiv.innerHTML = `
                                        ${message}
                                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                                    `;
                                    
                                    // –î–æ–±–∞–≤–ª—è–µ–º –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É
                                    const container = document.querySelector('.container') || document.body;
                                    container.insertBefore(alertDiv, container.firstChild);
                                    
                                    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∫—Ä—ã–≤–∞–µ–º —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
                                    setTimeout(() => {
                                        if (alertDiv.parentElement) {
                                            alertDiv.remove();
                                        }
                                    }, 5000);
                                }

                                // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—á–µ—Ç—á–∏–∫–∞ –∫–æ—Ä–∑–∏–Ω—ã
                                function updateCartCounter(count) {
                                    // –ò—â–µ–º –≤—Å–µ —ç–ª–µ–º–µ–Ω—Ç—ã —Å –∫–ª–∞—Å—Å–æ–º cart-count
                                    const counters = document.querySelectorAll('.cart-count, .badge.bg-danger');
                                    
                                    counters.forEach(counter => {
                                        counter.textContent = count;
                                        counter.style.display = count > 0 ? 'inline' : 'none';
                                    });
                                    
                                    // –ï—Å–ª–∏ —ç–ª–µ–º–µ–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω, —Å–æ–∑–¥–∞–µ–º –µ–≥–æ
                                    if (counters.length === 0 && count > 0) {
                                        console.log('–°—á–µ—Ç—á–∏–∫ –∫–æ—Ä–∑–∏–Ω—ã –Ω–µ –Ω–∞–π–¥–µ–Ω, —Å–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π');
                                        // –ú–æ–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å —Å—á–µ—Ç—á–∏–∫ –≤ —à–∞–ø–∫–µ
                                        const navbar = document.querySelector('.navbar-nav');
                                        if (navbar) {
                                            const cartLink = navbar.querySelector('a[href*="cart"]');
                                            if (cartLink) {
                                                const badge = document.createElement('span');
                                                badge.className = 'badge bg-danger rounded-pill ms-1';
                                                badge.textContent = count;
                                                cartLink.appendChild(badge);
                                            }
                                        }
                                    }
                                }
                                </script>

                                
                                <button class="btn btn-outline-primary btn-sm test-ajax-btn"
                                        data-product-id="{{ product.id }}"
                                        data-product-name="{{ product.name }}">
                                    <i class="bi bi-lightning"></i> –ë—ã—Å—Ç—Ä–æ –¥–æ–±–∞–≤–∏—Ç—å
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% empty %}
    <div class="text-center py-5">
        <div class="display-1 mb-3">üì¶</div>
        <h3 class="mb-3">–ö–∞—Ç–∞–ª–æ–≥ –ø—É—Å—Ç</h3>
        <p class="text-muted">–¢–æ–≤–∞—Ä—ã –ø–æ–∫–∞ –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã –≤ —Å–∏—Å—Ç–µ–º—É</p>
    </div>
    {% endfor %}
</div>

<!-- –ü—Ä–æ—Å—Ç–æ–π JavaScript –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('–ö–∞—Ç–∞–ª–æ–≥ –∑–∞–≥—Ä—É–∂–µ–Ω');
    
    // 1. –õ–æ–≥–∏—Ä—É–µ–º –æ—Ç–ø—Ä–∞–≤–∫—É —Ñ–æ—Ä–º
    document.querySelectorAll('form[action*="/cart/add/"]').forEach(form => {
        form.addEventListener('submit', function(e) {
            console.log('üì§ –§–æ—Ä–º–∞ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è:', this.action);
            console.log('üì¶ –¢–æ–≤–∞—Ä ID:', this.action.split('/').filter(p => p).pop());
            console.log('üî¢ –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ:', this.querySelector('input[name="quantity"]').value);
        });
    });
    
    // 2. –¢–µ—Å—Ç–æ–≤–∞—è AJAX –∫–Ω–æ–ø–∫–∞
    document.querySelectorAll('.test-ajax-btn').forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.preventDefault();
            const productId = this.dataset.productId;
            const productName = this.dataset.productName;
            
            console.log(`üéØ AJAX –∑–∞–ø—Ä–æ—Å –¥–ª—è —Ç–æ–≤–∞—Ä–∞: ${productName} (ID: ${productId})`);
            
            // –ü—Ä–æ—Å—Ç–æ–π –∑–∞–ø—Ä–æ—Å
            fetch(`/cart/add/${productId}/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                },
                body: 'quantity=1'
            })
            .then(response => {
                console.log(`üì® –°—Ç–∞—Ç—É—Å –æ—Ç–≤–µ—Ç–∞: ${response.status}`);
                if (response.redirected) {
                    console.log(`üîÑ –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞: ${response.url}`);
                    window.location.href = response.url;
                }
                return response.text();
            })
            .then(text => {
                console.log('üìÑ –û—Ç–≤–µ—Ç –ø–æ–ª—É—á–µ–Ω');
                alert(`–¢–æ–≤–∞—Ä "${productName}" –¥–æ–±–∞–≤–ª–µ–Ω –≤ –∫–æ—Ä–∑–∏–Ω—É!`);
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ –∫–æ—Ä–∑–∏–Ω—ã
                fetch('/cart/get-count/')
                    .then(r => r.json())
                    .then(data => {
                        const counter = document.getElementById('cart-count');
                        if (counter) {
                            counter.textContent = data.count;
                        }
                    });
            })
            .catch(err => {
                console.error('‚ùå –û—à–∏–±–∫–∞:', err);
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –≤ –∫–æ—Ä–∑–∏–Ω—É');
            });
        });
    });
});

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—á–µ—Ç—á–∏–∫–∞ –∫–æ—Ä–∑–∏–Ω—ã
function updateCartCounter() {
    fetch('/cart/get-count/')
        .then(r => r.json())
        .then(data => {
            const counter = document.getElementById('cart-count');
            if (counter) {
                counter.textContent = data.count;
            }
        });
}
</script>

<style>
.card {
    transition: transform 0.2s;
}
.card:hover {
    transform: translateY(-5px);
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
}
.btn-primary {
    background-color: #0d6efd;
    border-color: #0d6efd;
}
.btn-success {
    background-color: #198754;
    border-color: #198754;
}
.input-group-sm .form-control {
    padding: 0.25rem 0.5rem;
    font-size: 0.875rem;
}
</style>
{% endblock %}